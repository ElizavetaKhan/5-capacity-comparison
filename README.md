# Тестирование REST и gRPC приложений глоссария

## Описание тестируемых приложений

### Архитектура

Развёрнуты 2 сервиса для управления списком терминов:
- **FastAPI** с использованием REST-подхода (`app/src/rest_server.py`)
- **gRPC** приложение-словарь с использованием подхода RPC и передачи данных по протоколу protobuf (`app/src/server_main.py`)

### Используемые технологии

- **REST API**: FastAPI 0.115.6, Uvicorn 0.32.1
- **gRPC API**: gRPC 1.56.0, Protocol Buffers 4.24.4
- **Тестирование**: Locust 2.20.1

### Эндпоинты

В каждом сервисе реализованы следующие операции:

| Операция | REST | gRPC |
|----------|------|------|
| Получение всех терминов | `GET /` | `AllEntries` |
| Получение одного термина | `GET /entry/{key}` | `GetEntry` |
| Создание термина | `POST /entry/{key}` | `PostEntry` |
| Обновление термина | `PUT /entry/{key}` | `ModifyEntry` |
| Удаление термина | `DELETE /entry/{key}` | `DeleteEntry` |

### Структура данных

```python
class Entry:
    name: str
    description: str
    reference: Optional[str]
```

### Данные для создания записи

**REST API** (JSON):
```json
{
    "name": "название_термина",
    "description": "описание термина",
    "reference": "https://example.com"
}
```

**gRPC API** (Protobuf):
```protobuf
PostEntryRequest {
    key: "ключ_термина"
    entry: {
        name: "название_термина"
        description: "описание термина"
        reference: "https://example.com"
    }
}
```

### Архитектура стенда

Все компоненты запускаются на одном физическом устройстве:
- REST сервер: `localhost:8000`
- gRPC сервер: `localhost:50051`
- Locust Web UI: `localhost:8089`

### Инструменты мониторинга

- Locust Web UI (встроенный веб-интерфейс)
- Экспорт метрик в CSV и HTML

## Тестовые сценарии

### Классы пользователей

- `GlossaryRestUser` (`locust-tests/rest_user.py`)
- `GlossaryGrpcUser` (`locust-tests/grpc_user.py`)

### Поведение клиентов

- Пользователи последовательно выполняют доступные операции
- Между запросами пауза от 1 до 3 секунд
- Распределение запросов:
  - 50% - получение всех терминов (GET /)
  - 25% - получение одного термина (GET /entry/{key})
  - 15% - создание нового термина (POST)
  - 7% - обновление термина (PUT)
  - 3% - удаление термина (DELETE)

### 1. Лёгкая нагрузка (sanity check)

**Конфигурация:**
- Пользователи: 10
- Spawn rate: 2 пользователя/сек
- Длительность: 30 секунд

**Гипотезы:**
- Равномерный рост RPS
- Отсутствие просадок производительности
- Незначительный рост среднего времени ответа

### 2. Рабочая нагрузка (нормальный режим)

**Конфигурация:**
- Пользователи: 50
- Spawn rate: 5 пользователей/сек
- Длительность: 60 секунд

**Гипотезы:**
- Равномерный рост RPS
- Умеренный рост времени ответа
- Стабильная работа без ошибок

### 3. Стресс-тест (приближение к пику)

**Конфигурация:**
- Пользователи: 600
- Spawn rate: 5 пользователей/сек
- Длительность: 120 секунд

**Гипотезы:**
- Рост RPS с последующим падением
- Значительное увеличение времени ответа
- Появление ошибок при достижении предела

### 4. Тест на стабильность (длительная нагрузка)

**Конфигурация:**
- Пользователи: 30
- Spawn rate: 3 пользователя/сек
- Длительность: 600 секунд (10 минут)

**Гипотезы:**
- Стабильная работа в течение длительного времени
- Отсутствие деградации производительности
- Возможный рост использования памяти

### Фрагмент тестового кода Locust

```python
class GlossaryRestUser(HttpUser):
    wait_time = between(1, 3)
    
    @task(5)
    def get_all_entries(self):
        """Получить все записи - самая частая операция"""
        with self.client.get("/", catch_response=True, 
                           name="REST Get All Entries") as response:
            if response.status_code == 200:
                response.success()
            else:
                response.failure(f"Failed with status {response.status_code}")
    
    @task(2)
    def create_entry(self):
        """Создать новый термин"""
        new_entry = generate_random_entry()
        keyword = generate_random_keyword()
        with self.client.post(f"/entry/{keyword}", json=new_entry, 
                            catch_response=True, name="REST Create Entry") as response:
            if response.status_code == 200:
                response.success()
```

## Инструкция по запуску

### Подготовка

```bash
# Создание виртуального окружения
python -m venv venv
source venv/bin/activate

# Установка зависимостей
pip install -r requirements.txt

# Генерация proto файлов
python tools/build_proto.py
```

### REST

1. Запуск сервера:
```bash
python scripts/run_rest_server.py
```

2. Запуск тестирования (в отдельном терминале):
```bash
locust -f locust-tests/rest_user.py --host=http://127.0.0.1:8000
```

3. Веб-интерфейс: `http://localhost:8089`

### gRPC

1. Запуск сервера:
```bash
python scripts/run_grpc_server.py
```

2. Запуск тестирования (в отдельном терминале):
```bash
locust -f locust-tests/grpc_user.py --host=http://127.0.0.1:50051
```

3. Веб-интерфейс: `http://localhost:8089`

## Результаты тестирования

### REST API

#### Лёгкая нагрузка


#### Рабочая нагрузка


#### Стресс-тест


#### Тест на стабильность


### gRPC API

#### Лёгкая нагрузка


#### Рабочая нагрузка


#### Стресс-тест


#### Тест на стабильность


### Выводы о применимости

**REST рекомендуется для:**
- Быстрой разработки и прототипирования
- Публичных API
- Интеграции с веб-приложениями
- Не слишком высоких нагрузок

**gRPC рекомендуется для:**
- Микросервисной архитектуры
- Внутренней коммуникации между сервисами
- Высоких требований к производительности
- Строгой типизации API

### Основные выводы

### Возможные улучшения эксперимента

1. Добавление базы данных вместо in-memory хранилища
2. Распределенное тестирование на разных машинах
3. Мониторинг ресурсов (CPU, RAM, сеть)
4. Тестирование с различными объемами данных

### Ограничения проведённого тестирования

1. Все компоненты на одном устройстве (нет сетевых задержек)
2. Отсутствие внешних факторов (потери пакетов, DNS)
3. Искусственный характер нагрузки
4. Отсутствие базы данных
5. In-memory хранилище может привести к утечкам памяти
